{% extends "layout.twig" %}

{% block title %}Start comparision{% endblock%}

{% block contents %}
<h1>DbDiff</h1>
{% if errors|length > 0 %}
<h3>Erreurs</h3>
<div class="alert-box alert">
    {% for idx, errs in errors %}
        <h6>Database #{{ idx }}</h6>
        {% for error in errs %}
            - {{ error }}<br />
        {% endfor %}
    {% endfor %}
    <a href="" class="close">&times;</a>
</div>
{% endif %}

<form action="" method="post">
    {% for idx, values in databases %}
    <p>
        <label for="db_{{ idx }}_host">#{{ idx }}</label>
        <select name="db[{{ idx }}][driver]" id="db_{{ idx }}_driver">
            <option value="mysql" selected="selected">MySQL</option>
        </select>
        <input type="text" name="db[{{ idx }}][hostname]" id="db_{{ idx }}_host" value="{{ values.form.hostname|default("") }}" placeholder="Hostname" />
        <input type="text" name="db[{{ idx }}][username]" placeholder="Username" id="db_{{ idx }}_user" value="{{ values.form.username|default("") }}" />
        <input type="password" name="db[{{ idx }}][passwd]" placeholder="Password" id="db_{{ idx }}_passwd" value="{{ values.form.passwd|default("") }}" />
        <input type="text" name="db[{{ idx }}][database]" id="db_{{ idx }}_database" placeholder="Database name" value="{{ values.form.database|default("") }}" />
    </p>
    {% endfor %}
    
    <p>
        <br />
        <input type="submit" value="Comparer" /> - <a href="#">ajouter une autre base de donnée</a>
    </p>
</form>

{% if errors|length == 0 and submitted %}
<hr />

<h3>Differences</h3>
<p>La première connection est utilisée comme référence.</p>
{% for idx, db in databases %}
{% if db.schema_diff|default(null) != null %}
    {% set diff = db.schema_diff %}
    <h4>Database #{{ idx+1 }}: {{ db.form.database }} -&gt; {{ db.form.username }}@{{ db.form.hostname }}</h4>
    <section class="line grid2">
	<aside class="mod">
            <dl>
             <dt><strong>Nouvelles tables</strong></dt>
              <dd>{% for table in diff.newTables %}- {{ table.name }}<br />{% endfor %}</dd>
             <dt><strong>Tables manquantes</strong></dt>
              <dd>{% for table in diff.removedTables %}- {{ table.name }}<br />{% endfor %}</dd>
            <dt><strong>Tables différentes</strong></dt>
              <dd>
        {% for table in diff.changedTables %}
          <a href="#" class="icon icon-down"> {{ table.name }}</a><br />
          - {{ table.addedColumns|length }} nouvelles colonnes: {% for column in table.addedColumns %}{{ column.name }}, {% endfor %}<br />
          - {{ table.changedColumns|length }} colonnes modifiées: {% for column in table.changedColumns %}{{ column.column.name }}, {% endfor %}<br />
          - {{ table.removedColumns|length }} colonnes supprimées: {% for column in table.removedColumns %}{{ column.name }}, {% endfor %}<br />
          - {{ table.addedIndexes|length }} nouveaux index: {% for column in table.addedIndexes %}{{ column.name }}, {% endfor %}<br />
          - {{ table.changedIndexes|length }} index modifiées: {% for column in table.changedIndexes %}{{ column.name }}, {% endfor %}<br />
          - {{ table.removedIndexes|length }} index supprimés: {% for column in table.removedIndexes %}{{ column.name }}, {% endfor %}<br />
        {% endfor %}</dd>
            </dl> 
	</aside>
	<aside class="mod">
            <dl>
             <dt><strong>Nouvelles séquences</strong></dt>
              <dd>{% for table in diff.newSequences %}- {{ table.name }}<br />{% endfor %}</dd>
             <dt><strong>Séquences manquantes</strong></dt>
              <dd>{% for table in diff.removedSequences %}- {{ table.name }}<br />{% endfor %}</dd>
            <dt><strong>Séquences différentes</strong></dt>
              <dd>{% for table in diff.changedSequences %}- {{ table.name }}<br />{% endfor %}</dd>
             <dt><strong>ForeingKeys orphelines</strong></dt>
              <dd>{% for table in diff.orphanedForeignKeys %}- {{ table.name }}<br />{% endfor %}</dd>
            </dl>
        </aside>
</section>
    
<h6>SQL</h6>
<pre style="max-height: 200px; overflow-y: scroll"><code lang="sql">
{% for line in db.sql_diff %}
{{ line }};

{% endfor %}
</code></pre>
{% endif %}
{% endfor %}

{% endif %}
<hr />
<footer>dbdiff</footer>
{% endblock %}
